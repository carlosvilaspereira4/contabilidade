<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Atlético Cabeceirense</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #111827; }
        #root { width: 100%; min-height: 100vh; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
const { useState, useEffect, createElement: h } = React;
const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbzVOd4645cjOFl6IM_7dW0YtgynHFZavoXZcUZ0mLf3m97ctu6bCR25ejTvy1LxVfyS/exec';

// Icons with color parameter
const Download = ({size=24,color='currentColor'}) => h('svg',{width:size,height:size,viewBox:'0 0 24 24',fill:'none',stroke:color,strokeWidth:2},h('path',{d:'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'}),h('polyline',{points:'7 10 12 15 17 10'}),h('line',{x1:'12',y1:'15',x2:'12',y2:'3'}));
const LogOut = ({size=24,color='currentColor'}) => h('svg',{width:size,height:size,viewBox:'0 0 24 24',fill:'none',stroke:color,strokeWidth:2},h('path',{d:'M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4'}),h('polyline',{points:'16 17 21 12 16 7'}),h('line',{x1:'21',y1:'12',x2:'9',y2:'12'}));
const Filter = ({size=24,color='currentColor'}) => h('svg',{width:size,height:size,viewBox:'0 0 24 24',fill:'none',stroke:color,strokeWidth:2},h('polygon',{points:'22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3'}));
const X = ({size=24,color='currentColor'}) => h('svg',{width:size,height:size,viewBox:'0 0 24 24',fill:'none',stroke:color,strokeWidth:2},h('line',{x1:'18',y1:'6',x2:'6',y2:'18'}),h('line',{x1:'6',y1:'6',x2:'18',y2:'18'}));
const Edit2 = ({size=24,color='currentColor'}) => h('svg',{width:size,height:size,viewBox:'0 0 24 24',fill:'none',stroke:color,strokeWidth:2},h('path',{d:'M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z'}));
const Trash2 = ({size=24,color='currentColor'}) => h('svg',{width:size,height:size,viewBox:'0 0 24 24',fill:'none',stroke:color,strokeWidth:2},h('polyline',{points:'3 6 5 6 21 6'}),h('path',{d:'M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2'}),h('line',{x1:'10',y1:'11',x2:'10',y2:'17'}),h('line',{x1:'14',y1:'11',x2:'14',y2:'17'}));
const Check = ({size=24,color='currentColor'}) => h('svg',{width:size,height:size,viewBox:'0 0 24 24',fill:'none',stroke:color,strokeWidth:2},h('polyline',{points:'20 6 9 17 4 12'}));
const Paperclip = ({size=24,color='currentColor'}) => h('svg',{width:size,height:size,viewBox:'0 0 24 24',fill:'none',stroke:color,strokeWidth:2},h('path',{d:'M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48'}));
const Eye = ({size=24,color='currentColor'}) => h('svg',{width:size,height:size,viewBox:'0 0 24 24',fill:'none',stroke:color,strokeWidth:2},h('path',{d:'M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z'}),h('circle',{cx:'12',cy:'12',r:'3'}));
const RefreshCw = ({size=24,color='currentColor'}) => h('svg',{width:size,height:size,viewBox:'0 0 24 24',fill:'none',stroke:color,strokeWidth:2},h('polyline',{points:'23 4 23 10 17 10'}),h('polyline',{points:'1 20 1 14 7 14'}),h('path',{d:'M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15'}));

function App() {
  const [isFinanceDirector, setIsFinanceDirector] = useState(false);
  const [transactions, setTransactions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showFilters, setShowFilters] = useState(false);
  const [editingTransaction, setEditingTransaction] = useState(null);
  const [previewReceipt, setPreviewReceipt] = useState(null);
  const [formData, setFormData] = useState({user:'',type:'despesa',date:new Date().toISOString().split('T')[0],amount:'',description:'',category:'',receipt:null,isPaid:false});
  const [filters, setFilters] = useState({startDate:'',endDate:'',type:'',user:'',category:''});
  const users = ['Ana Rodrigues','André Gomes','Beatriz Sousa','Bruno Dias','Carlos Mendes','Catarina Lopes','Francisca Duarte','Inês Martins','João Silva','Joana Ribeiro','Maria Santos','Mariana Carvalho','Miguel Ferreira','Nuno Pinto','Pedro Costa','Ricardo Oliveira','Rui Moreira','Sofia Alves','Teresa Vieira','Tiago Pereira'];
  const categories = ['Alimentação','Transporte','Equipamento','Instalações','Arbitragem','Inscrições','Material Desportivo','Publicidade','Eventos','Quotas','Donativos','Outros'];

  const loadTransactions = async () => {
    setLoading(true);
    try {
      const response = await fetch(SHEETS_URL + '?action=getAll');
      const result = await response.json();
      if (result.success && result.data) {
        const txs = result.data.map(row => ({id: row.ID,user: row.Utilizador,type: row.Tipo,date: row.Data,amount: parseFloat(row.Valor) || 0,description: row.Descrição,category: row.Categoria,isPaid: row.Pago === 'true' || row.Pago === true,receipt: row.Comprovativo ? JSON.parse(row.Comprovativo) : null,createdAt: row.DataCriacao}));
        setTransactions(txs);
      }
    } catch(e) {console.error('Erro:',e);alert('Erro ao carregar.');}
    setLoading(false);
  };
  useEffect(() => {loadTransactions();}, []);

  const saveTransaction = async (tx, isUpdate = false) => {
    try {
      await fetch(SHEETS_URL, {method: 'POST',mode: 'no-cors',headers: {'Content-Type': 'application/json'},body: JSON.stringify({action: isUpdate ? 'update' : 'add',id: tx.id,user: tx.user,type: tx.type,date: tx.date,amount: tx.amount,description: tx.description,category: tx.category,isPaid: tx.isPaid,receipt: tx.receipt ? JSON.stringify(tx.receipt) : '',createdAt: tx.createdAt})});
      setTimeout(() => loadTransactions(), 1500);
      return true;
    } catch(e) {alert('Erro ao guardar.');return false;}
  };

  const deleteTransaction = async (id) => {
    try {
      await fetch(SHEETS_URL, {method: 'POST',mode: 'no-cors',headers: {'Content-Type': 'application/json'},body: JSON.stringify({action: 'delete', id: id})});
      setTimeout(() => loadTransactions(), 1500);
    } catch(e) {alert('Erro ao eliminar.');}
  };

  const handleSubmit = async () => {
    if (!formData.user || !formData.amount || !formData.description) {alert('Preencha nome, valor e descrição');return;}
    const tx = {id: editingTransaction ? editingTransaction.id : Date.now().toString(),user: formData.user,type: formData.type,date: formData.date,amount: parseFloat(formData.amount),description: formData.description,category: formData.category,receipt: formData.receipt,isPaid: formData.isPaid,createdAt: editingTransaction ? editingTransaction.createdAt : new Date().toISOString()};
    await saveTransaction(tx, !!editingTransaction);
    setFormData({user:formData.user,type:'despesa',date:new Date().toISOString().split('T')[0],amount:'',description:'',category:'',receipt:null,isPaid:false});
    setEditingTransaction(null);
    if(!isFinanceDirector) alert('Transação submetida!');
  };

  const handleDelete = async (id) => {if(confirm('Eliminar?')) await deleteTransaction(id);};
  const handleEdit = (tx) => {setEditingTransaction(tx);setFormData({user:tx.user,type:tx.type,date:tx.date,amount:tx.amount.toString(),description:tx.description,category:tx.category,receipt:tx.receipt,isPaid:tx.isPaid||false});window.scrollTo(0,0);};
  const handleReceipt = (e) => {const file = e.target.files[0];if(file) {const reader = new FileReader();reader.onloadend = () => setFormData({...formData,receipt:{data:reader.result,name:file.name}});reader.readAsDataURL(file);}};
  const getFiltered = () => {let f = isFinanceDirector ? transactions : transactions.filter(t=>t.user===formData.user);if(filters.startDate) f=f.filter(t=>t.date>=filters.startDate);if(filters.endDate) f=f.filter(t=>t.date<=filters.endDate);if(filters.type) f=f.filter(t=>t.type===filters.type);if(filters.user) f=f.filter(t=>t.user===filters.user);if(filters.category) f=f.filter(t=>t.category===filters.category);return f.sort((a,b)=>new Date(b.date)-new Date(a.date));};
  const getTotals = () => {const f = getFiltered();const despesas = f.filter(t=>t.type==='despesa').reduce((s,t)=>s+t.amount,0);const receitas = f.filter(t=>t.type==='receita').reduce((s,t)=>s+t.amount,0);return {despesas,receitas,saldo:receitas-despesas};};
  const exportCSV = () => {const f = getFiltered();if(f.length===0) {alert('Sem transações');return;}const csv = [['Data','Tipo','Colaborador','Valor','Descrição','Categoria','Pagamento'].join(','),...f.map(t=>[t.date,t.type==='despesa'?'Despesa':'Receita',t.user,t.amount.toFixed(2),t.description,t.category||'-',t.type==='despesa'?(t.isPaid?'Pago':'Pendente'):'-'].map(c=>`"${c}"`).join(','))].join('\\n');const blob = new Blob([csv],{type:'text/csv'});const a = document.createElement('a');a.href = URL.createObjectURL(blob);a.download = `transacoes_${new Date().toISOString().split('T')[0]}.csv`;a.click();alert(`Exportado ${f.length} transações`);};

  const DirectorBtn = () => {
    const [show,setShow] = useState(false);
    const [pwd,setPwd] = useState('');
    if(isFinanceDirector) return h('button',{onClick:()=>window.location.reload(),className:'bg-gray-800 text-red-400 px-3 py-2 rounded-lg text-xs flex items-center gap-1 border border-red-500/30 hover:bg-gray-700'},h(LogOut,{size:14,color:'#f87171'}),' Sair');
    if(!show) return h('button',{onClick:()=>setShow(true),className:'bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-2 rounded-lg text-xs border border-gray-600'},'Diretor');
    return h('div',{className:'bg-gray-800 border border-gray-600 rounded-xl p-4'},h('div',{className:'flex gap-2'},h('input',{type:'password',value:pwd,onChange:e=>setPwd(e.target.value),onKeyPress:e=>e.key==='Enter'&&pwd==='financas2025'&&setIsFinanceDirector(true),className:'bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm w-32',placeholder:'Password',autoFocus:true}),h('button',{onClick:()=>{if(pwd==='financas2025'){setIsFinanceDirector(true);setShow(false)}else alert('Password incorreta')},className:'bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm'},'OK'),h('button',{onClick:()=>{setShow(false);setPwd('')},className:'text-gray-400 hover:text-gray-200 p-2'},h(X,{size:16}))));
  };

  const totals = getTotals();
  const filtered = getFiltered();

  if(loading) {
    return h('div',{className:'min-h-screen bg-gray-900 flex items-center justify-center'},
      h('div',{className:'text-center'},
        h('div',{className:'animate-spin rounded-full h-16 w-16 border-b-2 border-red-500 mx-auto mb-4'}),
        h('p',{className:'text-white text-lg'},'A carregar...')
      )
    );
  }

  return h('div',{className:'min-h-screen bg-gray-900'},
    h('div',{className:'absolute top-4 right-4 z-20 flex gap-2'},
      h('button',{onClick:loadTransactions,className:'bg-gray-800 hover:bg-gray-700 text-gray-300 p-2 rounded-lg border border-gray-600',title:'Atualizar'},h(RefreshCw,{size:16})),
      h(DirectorBtn)
    ),
    h('div',{className:'bg-gray-800 text-white p-4 border-b border-gray-700'},
      h('div',{className:'max-w-4xl mx-auto text-center'},
        h('h1',{className:'text-2xl font-bold'},'Atlético Cabeceirense'),
        h('p',{className:'text-sm text-gray-400'},isFinanceDirector?'Diretor Financeiro':'Reportar Transação')
      )
    ),
    isFinanceDirector && h('div',{className:'bg-gray-800/50 border-b border-gray-700 p-4'},
      h('div',{className:'max-w-4xl mx-auto grid grid-cols-3 gap-4'},
        h('div',{className:'bg-gray-800 rounded-xl p-4 text-center border border-gray-700'},h('p',{className:'text-sm text-gray-400'},'Despesas'),h('p',{className:'text-xl font-bold text-red-400'},`-${totals.despesas.toFixed(2)}€`)),
        h('div',{className:'bg-gray-800 rounded-xl p-4 text-center border border-gray-700'},h('p',{className:'text-sm text-gray-400'},'Receitas'),h('p',{className:'text-xl font-bold text-green-400'},`+${totals.receitas.toFixed(2)}€`)),
        h('div',{className:'bg-gray-800 rounded-xl p-4 text-center border border-gray-700'},h('p',{className:'text-sm text-gray-400'},'Saldo'),h('p',{className:`text-xl font-bold ${totals.saldo>=0?'text-green-400':'text-red-400'}`},`${totals.saldo.toFixed(2)}€`))
      )
    ),
    h('div',{className:'max-w-4xl mx-auto p-4'},
      !isFinanceDirector && h('div',{className:'bg-gray-800 rounded-2xl p-6 border border-gray-700 space-y-4 mb-6'},
        h('h2',{className:'text-xl font-bold text-white mb-4'},'Reportar Transação'),
        h('div',null,h('label',{className:'block text-sm font-medium text-gray-300 mb-2'},'Nome *'),h('select',{value:formData.user,onChange:e=>setFormData({...formData,user:e.target.value}),className:'w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white'},h('option',{value:''},'Selecione...'),users.map(u=>h('option',{key:u,value:u},u)))),
        h('div',null,h('label',{className:'block text-sm text-gray-300 mb-2'},'Tipo'),h('div',{className:'grid grid-cols-2 gap-2'},h('button',{onClick:()=>setFormData({...formData,type:'despesa'}),className:`py-3 px-4 rounded-xl font-medium border-2 ${formData.type==='despesa'?'bg-red-600 text-white border-red-500':'bg-gray-700 text-gray-300 border-gray-600'}`},'Despesa'),h('button',{onClick:()=>setFormData({...formData,type:'receita'}),className:`py-3 px-4 rounded-xl font-medium border-2 ${formData.type==='receita'?'bg-blue-600 text-white border-blue-500':'bg-gray-700 text-gray-300 border-gray-600'}`},'Receita'))),
        h('div',null,h('label',{className:'block text-sm text-gray-300 mb-2'},'Data'),h('input',{type:'date',value:formData.date,onChange:e=>setFormData({...formData,date:e.target.value}),className:'w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white'})),
        h('div',null,h('label',{className:'block text-sm text-gray-300 mb-2'},'Valor (€) *'),h('input',{type:'number',step:'0.01',value:formData.amount,onChange:e=>setFormData({...formData,amount:e.target.value}),className:'w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white',placeholder:'0.00'})),
        h('div',null,h('label',{className:'block text-sm text-gray-300 mb-2'},'Descrição *'),h('textarea',{value:formData.description,onChange:e=>setFormData({...formData,description:e.target.value}),className:'w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white',rows:3,placeholder:'Descreva...'})),
        h('div',null,h('label',{className:'block text-sm text-gray-300 mb-2'},'Categoria'),h('select',{value:formData.category,onChange:e=>setFormData({...formData,category:e.target.value}),className:'w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white'},h('option',{value:''},'Sem categoria'),categories.map(c=>h('option',{key:c,value:c},c)))),
        formData.type==='despesa' && h('label',{className:'flex items-center gap-3 cursor-pointer'},h('input',{type:'checkbox',checked:formData.isPaid,onChange:e=>setFormData({...formData,isPaid:e.target.checked}),className:'w-5 h-5 accent-red-600'}),h('span',{className:'text-sm text-gray-300'},'Já foi paga')),
        h('div',null,h('label',{className:'block text-sm text-gray-300 mb-2'},'Comprovativo'),h('input',{type:'file',accept:'image/*',onChange:handleReceipt,className:'w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-2 text-white file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-red-600 file:text-white file:cursor-pointer'}),formData.receipt&&h('div',{className:'mt-2 flex items-center gap-2 bg-gray-700 p-2 rounded border border-gray-600'},h(Paperclip,{size:16,color:'#60a5fa'}),h('span',{className:'text-sm text-gray-300 flex-1'},formData.receipt.name),h('button',{onClick:()=>setFormData({...formData,receipt:null}),className:'text-red-400 hover:text-red-300'},h(X,{size:16,color:'#f87171'})))),
        h('button',{onClick:handleSubmit,className:'w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 border-2 border-red-500'},h(Check,{size:20}),editingTransaction?'Guardar':'Submeter')
      ),
      isFinanceDirector && h('div',{className:'flex gap-2 mb-4'},h('button',{onClick:()=>setShowFilters(!showFilters),className:'flex-1 bg-gray-800 text-white py-3 rounded-xl flex items-center justify-center gap-2 border border-gray-700 hover:bg-gray-700'},h(Filter,{size:20}),'Filtros'),h('button',{onClick:exportCSV,className:'flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl flex items-center justify-center gap-2 border-2 border-blue-500'},h(Download,{size:20}),'CSV')),
      h('h2',{className:'text-white text-lg font-semibold mb-3 flex items-center gap-2'},isFinanceDirector?'Todas as Transações':'Minhas Transações'),
      h('div',{className:'space-y-3'},
        filtered.length===0?h('div',{className:'bg-gray-800 rounded-xl p-8 text-center text-gray-400 border border-gray-700'},'Sem transações'):filtered.map(t=>
          h('div',{key:t.id,className:'bg-gray-800 rounded-xl p-4 border border-gray-700 hover:border-gray-600'},
            h('div',{className:'flex justify-between'},
              h('div',{className:'flex-1'},
                h('div',{className:'flex gap-2 mb-2 flex-wrap'},
                  h('span',{className:`px-3 py-1 text-xs font-bold rounded-lg border-2 ${t.type==='despesa'?'bg-red-500/10 text-red-400 border-red-500/30':'bg-blue-500/10 text-blue-400 border-blue-500/30'}`},t.type==='despesa'?'DESPESA':'RECEITA'),
                  t.category&&h('span',{className:'text-xs text-gray-400 bg-gray-700/50 px-2 py-1 rounded border border-gray-600'},t.category),
                  t.type==='despesa'&&h('span',{className:`text-xs px-2 py-1 rounded border ${t.isPaid?'bg-green-500/10 text-green-400 border-green-500/30':'bg-orange-500/10 text-orange-400 border-orange-500/30'}`},t.isPaid?'✓ Pago':'Pendente')
                ),
                isFinanceDirector&&h('p',{className:'text-sm font-semibold text-gray-200 mb-1'},t.user),
                h('p',{className:'text-gray-300 mb-2'},t.description),
                h('div',{className:'flex justify-between items-center'},
                  h('p',{className:'text-xs text-gray-500'},new Date(t.date).toLocaleDateString('pt-PT')),
                  h('p',{className:`text-xl font-bold ${t.type==='despesa'?'text-red-400':'text-blue-400'}`},`${t.type==='despesa'?'-':'+'}${t.amount.toFixed(2)}€`)
                ),
                t.receipt&&h('button',{onClick:()=>setPreviewReceipt(t.receipt.data),className:'mt-2 text-xs text-blue-400 flex items-center gap-1 hover:text-blue-300'},h(Paperclip,{size:14,color:'#60a5fa'}),t.receipt.name,' ',h(Eye,{size:14,color:'#60a5fa'}))
              ),
              h('div',{className:'flex gap-2 ml-2'},h('button',{onClick:()=>handleEdit(t),className:'p-2 text-blue-400 hover:bg-blue-500/20 rounded-lg border border-transparent hover:border-blue-500/30'},h(Edit2,{size:18,color:'#60a5fa'})),h('button',{onClick:()=>handleDelete(t.id),className:'p-2 text-red-400 hover:bg-red-500/20 rounded-lg border border-transparent hover:border-red-500/30'},h(Trash2,{size:18,color:'#f87171'})))
            )
          )
        )
      )
    ),
    previewReceipt&&h('div',{className:'fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4',onClick:()=>setPreviewReceipt(null)},h('div',{className:'relative'},h('button',{onClick:()=>setPreviewReceipt(null),className:'absolute -top-12 right-0 px-4 py-2 bg-gray-800 rounded-lg text-white border border-gray-600 hover:bg-gray-700'},h(X,{size:24}),'Fechar'),h('img',{src:previewReceipt,alt:'Comprovativo',className:'max-w-full max-h-[90vh] rounded-lg border-4 border-gray-700'})))
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(h(App));
    </script>
</body>
</html>
